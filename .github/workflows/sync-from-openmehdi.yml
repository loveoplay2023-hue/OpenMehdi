name: Build OpenMehdi

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout OpenMehdi
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Clone openclaw source
        run: |
          git clone --depth=1 https://github.com/openclaw/openclaw.git /tmp/openclaw

      - name: Remove secret-containing files from source
        run: |
          rm -rf /tmp/openclaw/extensions/google-antigravity-auth
          rm -rf /tmp/openclaw/.secrets.baseline
          find /tmp/openclaw -name '*.env' -delete || true
          find /tmp/openclaw -name '.env*' -delete || true
          echo "Secret files removed from source"

      - name: Copy all folders (excluding .github)
        run: |
          cd /tmp/openclaw
          for dir in .agent .agents .pi .vscode Swabble apps assets docs extensions git-hooks packages patches scripts skills src test ui vendor; do
            if [ -d "$dir" ]; then
              cp -r "$dir" "$GITHUB_WORKSPACE/"
              echo "Copied: $dir"
            fi
          done
          for f in *.mjs *.json *.md *.yaml *.yml *.toml *.lock *.ts *.js; do
            [ -f "$f" ] && cp "$f" "$GITHUB_WORKSPACE/" && echo "Copied file: $f" || true
          done

      - name: Rename all openclaw references to openmehdi
        run: |
          cd "$GITHUB_WORKSPACE"
          [ -f openclaw.mjs ] && mv openclaw.mjs openmehdi.mjs || true
          [ -f openclaw.podman.env ] && mv openclaw.podman.env openmehdi.podman.env || true
          find . -not -path './.git/*' -not -path './.github/*' -type f \( -name '*.json' -o -name '*.ts' -o -name '*.js' -o -name '*.mjs' -o -name '*.md' -o -name '*.yaml' -o -name '*.yml' \) \
            -exec sed -i 's/openclaw/openmehdi/g; s/OpenClaw/OpenMehdi/g; s/OPENCLAW/OPENMEHDI/g' {} \; 2>/dev/null || true
          echo "Rename done"

      - name: Scrub remaining secrets in all files
        run: |
          cd "$GITHUB_WORKSPACE"
          find . -not -path './.git/*' -not -path './.github/*' -type f -name '*.ts' \
            -exec sed -i 's/GOCSPX-[A-Za-z0-9_-]*/GOCSPX-REMOVED/g' {} \; 2>/dev/null || true
          find . -not -path './.git/*' -not -path './.github/*' -type f -name '*.ts' \
            -exec sed -i 's/[0-9]\{12\}-[a-z0-9]\{32\}\.apps\.googleusercontent\.com/GOOGLE_CLIENT_ID_REMOVED/g' {} \; 2>/dev/null || true
          echo "Secret scrubbing done"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push
        run: |
          cd "$GITHUB_WORKSPACE"
          git add -A
          git diff --cached --stat
          git diff --cached --quiet && echo "Nothing to commit" && exit 0
          git commit -m "feat: integrate openclaw source into OpenMehdi, rename all references"
          git push origin HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
