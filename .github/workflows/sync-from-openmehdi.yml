name: Build OpenMehdi from openclaw source

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout OpenMehdi
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Clone openclaw source
        run: |
          git clone --depth=1 https://github.com/openclaw/openclaw.git /tmp/openclaw

      - name: Copy all missing folders (excluding .github)
        run: |
          cd /tmp/openclaw
          for dir in .agent .agents .pi .vscode Swabble apps assets docs extensions git-hooks packages patches scripts skills src test ui vendor; do
            if [ -d "$dir" ]; then
              cp -r "$dir" "$GITHUB_WORKSPACE/"
              echo "Copied: $dir"
            fi
          done

      - name: Remove files with real secrets or API keys
        run: |
          cd "$GITHUB_WORKSPACE"
          rm -f .secrets.baseline
          if [ -f .env.example ]; then
            sed -i 's/=.*/=YOUR_KEY_HERE/g' .env.example || true
          fi
          echo "Secret cleaning done"

      - name: Rename openclaw to openmehdi in key files
        run: |
          cd "$GITHUB_WORKSPACE"
          [ -f openclaw.mjs ] && mv openclaw.mjs openmehdi.mjs || true
          [ -f openclaw.podman.env ] && mv openclaw.podman.env openmehdi.podman.env || true
          find . -name 'package.json' -not -path './.git/*' -maxdepth 3 -exec sed -i 's/"name": "openclaw"/"name": "openmehdi"/g' {} \; 2>/dev/null || true
          echo "Rename done"

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit and push
        run: |
          cd "$GITHUB_WORKSPACE"
          git add -A
          git diff --cached --stat
          git diff --cached --quiet && echo "Nothing to commit" && exit 0
          git commit -m "chore: sync source folders from openclaw, rename to openmehdi"
          git push origin HEAD:main
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
